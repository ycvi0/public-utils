-- Optimized server hopping script for Roblox with rate-limiting
-- Made By key

local PlaceID = getgenv().placeId
local AllIDs = {}
local foundAnything = ""
local actualHour = os.date("!*t").hour
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game.Players
local jsonFileName = "NotSameServers.json"
local retryDelay = 10 -- Initial delay for retrying failed requests
local maxRetryDelay = 60 -- Maximum delay for retrying failed requests

-- Load existing IDs or create a new file
local function loadIDs()
    local success, result = pcall(function()
        return HttpService:JSONDecode(readfile(jsonFileName))
    end)
    if success and type(result) == "table" then
        AllIDs = result
    else
        AllIDs = {actualHour}
        writefile(jsonFileName, HttpService:JSONEncode(AllIDs))
    end
end

-- Save IDs to file
local function saveIDs()
    writefile(jsonFileName, HttpService:JSONEncode(AllIDs))
end

-- Clear the file if the hour has changed
local function clearFileIfHourChanged()
    if tonumber(actualHour) ~= tonumber(AllIDs[1]) then
        pcall(function()
            delfile(jsonFileName)
        end)
        AllIDs = {actualHour}
        saveIDs()
    end
end

-- Fetch the server data from the Roblox API
local function fetchServers(cursor)
    local url = 'https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Desc&excludeFullGames=true&limit=100'
    if cursor then
        url = url .. '&cursor=' .. cursor
    end
    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet(url))
    end)
    if not success then
        warn("Failed to fetch servers: " .. tostring(result))
        return nil
    end
    return result
end

-- Attempt to teleport to a new server
local function tryTeleport(ID)
    table.insert(AllIDs, ID)
    saveIDs()
    TeleportService:TeleportToPlaceInstance(PlaceID, ID, Players.LocalPlayer)
    wait(5)
end

-- Main function to find and teleport to a suitable server
local function TPReturner()
    local Site = fetchServers(foundAnything)
    if not Site then
        wait(retryDelay)
        retryDelay = math.min(retryDelay * 2, maxRetryDelay) -- Exponential backoff
        return
    end

    -- Reset retry delay on success
    retryDelay = 10

    if Site.nextPageCursor then
        foundAnything = Site.nextPageCursor
    end

    clearFileIfHourChanged()

    for _, server in ipairs(Site.data) do
        local ID = tostring(server.id)
        if tonumber(server.maxPlayers) > tonumber(server.playing) and not table.find(AllIDs, ID) then
            tryTeleport(ID)
            break
        end
    end
end

-- Main teleport loop
local function Teleport()
    while wait(3) do
        pcall(TPReturner)
    end
end

-- Load IDs and start the teleport process
loadIDs()
Teleport()
